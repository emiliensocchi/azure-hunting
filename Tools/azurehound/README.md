# AzureHound

Collection of hunting resources for attack path identification with BloodHound. 


## Requirements

- [AzureHound](https://github.com/BloodHoundAD/AzureHound/releases)
- [BloodHound Legacy](https://github.com/BloodHoundAD/BloodHound)
- [Neo4j 4.4.x](https://neo4j.com/download-center/#community) ([more info](https://bloodhound.readthedocs.io/en/latest/installation/windows.html#install-neo4j))


## Directory structure

All commands in this repository consider that the following directory strucutre is used for the BloodHound workflow:

```
├── [d] BloodHound
├───├── [f] BloodHound.exe
├── [d] neo4j 
├───├── [f] neo4j-community-4.*.*
├── [f] aad.json (once collected)
├── [f] azure.json (once collected)
├── [f] azurehound.exe
```


## Instructions

### 1. Start neo4j

#### Native console application

```shell
<neo4j_folder>\bin\neo4j console
```

#### Containerized

```shell
docker run --rm -d -e NEO4J_AUTH='neo4j/toor' -e NEO4J_dbms_allow_upgrade=true -p 127.0.0.1:7687:7687 -p 127.0.0.1:7474:7474 -v emilien_neo4j-data:/data neo4j:4.4 neo4j
```

### 2. Collect Entra ID data

**Note 1**: make sure the audience is `https://graph.microsoft.com/` and **NOT** `https://graph.windows.net`

**Note 2**: acquiring an access token manually can be obtained by browsing to `https://myaccount.microsoft.com`

```shell
./azurehound -j <access_token> list az-ad -o entraid.json -v 2
```

### 3. Collect Azure data

**Note 1**: make sure the audience is `https://management.azure.com` and **NOT** `https://management.core.windows.net`

**Note 2**: acquiring an access token manually can be obtained by browsing to `https://cosmos.azure.com`

```shell
./azurehound -j <access_token> list az-rm -o azure.json -v 2
```

### 4. Deal with errors when importing data

Sometimes, the BloodHound Legacy client will fail at parsing data from a fed .json file, preventing data from being uploaded to neo4j.

In those situations, using the BloodHound CE client may help. The high-level instructions are as follows:
1. Deploy [BloodHound CE](https://github.com/SpecterOps/BloodHound) with docker compose
2. Upload the data via the BloodHound CE web interface
3. Take down the infrastructure with "docker compose down"
4. Re-redeploy a new containerized version of neo4j (see section 1 above), which mounts the docker volume created in step 1 (it should be called 'emilien_neo4j-data')
5. Use the BloodHound Legacy client as usual (note: the password to the neo4j database generated by BH CE is `bloodhoundcommunityedition`)


## Custom queries

Replace the content of the following file with [customqueries.json](https://github.com/emiliensocchi/azure-hunting/blob/main/Tools/azurehound/customqueries.json):
```code
C:\Users\%USERNAME%\AppData\Roaming\bloodhound\customqueries.json
```
In Linux 
```code
curl -o ~/.config/bloodhound/customqueries.json "https://raw.githubusercontent.com/emiliensocchi/azure-hunting/main/Tools/azurehound/customqueries.json"
```
